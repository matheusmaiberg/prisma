# Configurações de Integrações - Sistema Prisma
# Define integrações com ferramentas externas (Claude Code, n8n)

metadata:
  versao: '1.1.0'
  ultima_atualizacao: '2025-11-02'
  status: 'Ativo'
  total_integracoes: 2

integracoes:
  claude_code:
    habilitado: true
    modo_invocacao: 'cli'
    cli_path: 'claude'

  n8n:
    habilitado: false

    # Conexão
    conexao:
      url: 'http://localhost:5678'
      autenticacao:
        tipo: 'api_key'  # ou 'basic', 'bearer', 'none'
        header: 'X-N8N-API-KEY'
        # valor configurado em variável de ambiente N8N_API_KEY
      timeout: 30000
      retry:
        habilitado: true
        max_tentativas: 3
        delay_ms: 1000

    # Webhooks que n8n pode chamar
    webhooks:
      fase_iniciada:
        habilitado: true
        url: '/webhook/prisma/fase-iniciada'
        metodo: 'POST'
        payload:
          - feature_name
          - fase
          - timestamp
          - usuario

      fase_concluida:
        habilitado: true
        url: '/webhook/prisma/fase-concluida'
        metodo: 'POST'
        payload:
          - feature_name
          - fase
          - status
          - quality_score
          - timestamp

      quality_gate_falhou:
        habilitado: true
        url: '/webhook/prisma/quality-gate-falhou'
        metodo: 'POST'
        payload:
          - feature_name
          - fase
          - gate
          - detalhes
          - bloqueante

      implementacao_iniciada:
        habilitado: true
        url: '/webhook/prisma/impl-iniciada'
        metodo: 'POST'

      implementacao_concluida:
        habilitado: true
        url: '/webhook/prisma/impl-concluida'
        metodo: 'POST'

      testes_executados:
        habilitado: true
        url: '/webhook/prisma/testes-executados'
        metodo: 'POST'
        payload:
          - feature_name
          - cobertura
          - passou
          - falhas

    # Workflows n8n disparados pelo Prisma
    workflows:
      notificar_equipe:
        habilitado: true
        workflow_id: 'notificar-equipe-prisma'
        trigger_em:
          - fase_concluida
          - quality_gate_falhou
          - implementacao_concluida

      criar_pull_request:
        habilitado: true
        workflow_id: 'criar-pr-automatico'
        trigger_em:
          - implementacao_concluida
        condicoes:
          - todos_testes_passaram: true
          - quality_score: '>=8'

      atualizar_jira:
        habilitado: false
        workflow_id: 'sync-jira-prisma'
        trigger_em:
          - fase_concluida
          - implementacao_concluida

      gerar_relatorio:
        habilitado: true
        workflow_id: 'relatorio-semanal'
        schedule: 'cron'
        cron: '0 9 * * 1'  # Toda segunda às 9h

      backup_especificacoes:
        habilitado: true
        workflow_id: 'backup-specs'
        schedule: 'cron'
        cron: '0 0 * * *'  # Diariamente à meia-noite

    # Mapeamento de eventos Prisma → n8n
    eventos:
      nova_especificacao:
        webhook: '/webhook/n8n/nova-spec'
        habilitado: true

      especificacao_aprovada:
        webhook: '/webhook/n8n/spec-aprovada'
        habilitado: true

      risco_identificado:
        webhook: '/webhook/n8n/risco-alto'
        habilitado: true
        filtro:
          nivel_minimo: 'alto'

      decisao_arquitetural:
        webhook: '/webhook/n8n/decisao-adr'
        habilitado: true

    # Configurações de Payload
    payload_config:
      formato: 'json'
      incluir_metadata: true
      incluir_contexto: true
      compactar: false

      # Headers customizados
      headers:
        'X-Prisma-Version': '1.1.0'
        'X-Prisma-Event-Source': 'prisma-workflow'

    # Logging e Monitoramento
    logging:
      habilitado: true
      nivel: 'info'  # debug, info, warn, error
      log_payloads: false  # por questões de privacidade
      log_respostas: true
